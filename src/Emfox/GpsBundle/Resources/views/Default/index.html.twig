<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>物流定位监控系统</title>
<style type="text/css">
html{height:100%;}
body{height:100%;margin:0px;padding:0px;}
#top{width:100%;height:79px;border-bottom:1px solid #ccc;background:#eee;}
#top_content{font-size:30px;text-align:center;}
#aside{position:absolute;top:80px;width:159px;border-right:1px solid #bbb;background:#ddd;}
#map{margin-left:160px;}
</style>
<script type="text/javascript" src="{{ asset('bundles/emfoxgps/js/jquery-1.4.4.min.js') }}"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=vnqN3eXrBMk2YTtYZsWL1Qru"></script>
</head>

<body onload="init()" onresize="checkSize()">
<div id="top"><div id="top_content">物流定位监控系统</div></div>
<div id="main">
<div id="aside">单位列表
{{ render(controller('EmfoxGpsBundle:Category:hierarchy',{'root':0})) }}
<div id="updatepoints" ajax-url="{{ path('category_ajax') }}">Click to update</div></div>
<div id="map"></div>
</div>
</body>
<script type="text/javascript">
//百度地图API功能
var map = new BMap.Map("map",{mapType: BMAP_HYBRID_MAP});
map.centerAndZoom(new BMap.Point(116.384, 39.925), 15);

    $('#updatepoints').click(function() {
        $.get($(this).attr("ajax-url"), function (data) {
            points = $.parseJSON( data ).points;
            Object.keys(points).forEach(function(key) {
                point = points[key];
                p = new BMap.Point(point.lng,point.lat);
                c = "<p>单位："+point.title+"</p><p>更新时间："+ point.time+"</p>";
                addMarker(p,c);
            });
		});
    });

function checkSize() {
	var h = document.documentElement.clientHeight;
	document.getElementById('aside').style.height = h - 80 + "px";
	document.getElementById('map').style.height = h - 80 + "px";
	}
function init() {
	checkSize();
	}

function addMarker(point,content){  
    var marker = new BMap.Marker(point);  
    //var infoWindow = new BMap.InfoWindow(sContent);   
    var infoWindow = new BMap.InfoWindow(content);   
    map.addOverlay(marker);  
    marker.addEventListener("click", function(){            
        this.openInfoWindow(infoWindow);  
        //图片加载完毕重绘infowindow  
        //document.getElementById('imgDemo').onload = function (){  
        //    infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏  
        //};  
    });
}


</script>
</html>