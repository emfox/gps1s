<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>物流定位监控系统</title>
<style type="text/css">
html {
	height: 100%;
}

body {
	height: 100%;
	margin: 0px;
	padding: 0px;
}

#top {
	width: 100%;
	height: 79px;
	border-bottom: 1px solid #ccc;
	background: #eee;
}

#top_content {
	font-size: 30px;
	text-align: center;
}

#aside {
	position: absolute;
	top: 80px;
	width: 159px;
	border-right: 1px solid #bbb;
	background: #ddd;
}

#map {
	margin-left: 160px;
}
</style>
<script type="text/javascript"
	src="{{ asset('bundles/emfoxgps/js/jquery-1.4.4.min.js') }}"></script>
<script type="text/javascript"
	src="{{ asset('bundles/emfoxgps/js/coords_trans.js') }}"></script>
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=vnqN3eXrBMk2YTtYZsWL1Qru"></script>
</head>

<body onresize="checkSize()">
	<div id="top">
		<div id="top_content">物流定位监控系统</div>
	</div>
	<div id="main">
		<div id="aside">
			单位列表 {{
			render(controller('EmfoxGpsBundle:Category:hierarchy',{'root':0})) }}
			<input type="button" value="手动刷新" id="updatepoints" ajax-url="{{ path('category_ajax') }}" />
			<input type="button" value="当前位置" id="allpoints" />
			<div>百度加密坐标<input type="text" id="mouse_pos_bd09" />
			GPS真实坐标<input type="text" id="mouse_pos_wgs84" /></div>
		</div>
		<div id="map"></div>
	</div>
</body>
<script type="text/javascript">
var map;
var bdpoints = new Array();
$(document).ready(function(){
	checkSize();
	map = new BMap.Map("map",{mapType: BMAP_HYBRID_MAP});
	map.centerAndZoom(new BMap.Point(116.384, 39.925), 15);
	map.setDefaultCursor("default");

    $('#updatepoints').click(function() {
        $.get($(this).attr("ajax-url"), function (data) {
            points = $.parseJSON(data).points;
            map.clearOverlays();
            Object.keys(points).forEach(function(key) {
                addMarker(points[key]);
            });
		});
    });

    $('#allpoints').click(function() {
        map.setViewport(bdpoints,{zoomFactor:-1});
    });
    map.addEventListener("mousemove",function(e){
        $('#mouse_pos_bd09').val(e.point.lng+","+e.point.lat);
        p=bd2wgs(e.point);
        p.lng=Math.round(p.lng*1000000)/1000000;
        p.lat=Math.round(p.lat*1000000)/1000000;
        $('#mouse_pos_wgs84').val(p.lng+","+p.lat);
    });
});
function checkSize() {
	var h = document.documentElement.clientHeight;
	document.getElementById('aside').style.height = h - 80 + "px";
	document.getElementById('map').style.height = h - 80 + "px";
	}

function addMarker(point){ 
    p = new BMap.Point(point.lng,point.lat);
    bdpoints.push(p);
    content = "<p>单位："+point.title+"</p><p>更新时间："+ point.time+"</p>";
    var marker = new BMap.Marker(p);  
    var infoWindow = new BMap.InfoWindow(content);   
    map.addOverlay(marker);  
    marker.addEventListener("click", function(){            
        this.openInfoWindow(infoWindow);  
    });
    opts = {
  		  position : p,    // 指定文本标注所在的地理位置
  		  offset   : new BMap.Size(10, -15)    //设置文本偏移量
  		}
	var label = new BMap.Label(point.title, opts);
	map.addOverlay(label);
    label.addEventListener("click", function(){            
        this.hide();  
    });
}


</script>
</html>